<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <!-- links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/main.css" /> 
</head>
<body>
    <!-- navbar -->
    <div id="navbar-container"></div>

    <div class="container py-4">
        <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
            <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                Add Device
            </button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-4">
                <a href="/admin/all_devices.html" style="text-decoration: none; color: inherit;">
                    <div class="card p-4 text-center">
                        <h1 id="totalDevices" class="display-4">0</h1>
                        <p class="text-muted">Total No. of Device</p>
                    </div>
                </a>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card p-4 text-center">
                    <h1 id="totalUsers" class="display-4">0</h1>
                    <p class="text-muted">Total No. of User</p>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card p-4 text-center">
                    <h1 id="totalLinkedDevices" class="display-4">0</h1>
                    <p class="text-muted">Total No. of Linked Device</p>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card p-4 card-graph text-center">
                    <canvas id="devicesPerMonthChart"></canvas>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card p-4 card-graph text-center">
                    <canvas id="newUsersChart"></canvas>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card p-4 card-graph text-center">
                    <canvas id="linkedDevicesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="addDeviceModalLabel">Add Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addDeviceForm">
                        <div class="mb-3">
                            <label for="deviceSerial" class="form-label fw-semibold">Serial Number:</label>
                            <input type="text" class="form-control" id="deviceSerial" name="deviceSerial" placeholder="Enter 5-digit number" maxlength="5" required>
                            <div class="form-text">Enter 5-digit number (will be prefixed with PPSC-)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-primary" id="saveDeviceBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Load navbar
        fetch('/components/navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
            })
            .catch(error => console.error('Error loading navbar:', error));

        document.addEventListener('DOMContentLoaded', async function() {
            // CSRF token management
            let csrfToken = null;
            
            async function fetchCSRFToken() {
                try {
                    const response = await fetch('/api/admin/csrf-token', { 
                        method: 'GET',
                        credentials: 'include' 
                    });
                    const data = await response.json();
                    if (data.success) {
                        csrfToken = data.token;
                        console.log('CSRF Token fetched successfully');
                    } else {
                        console.error('Failed to fetch CSRF token:', data.message);
                    }
                } catch (error) {
                    console.error('Error fetching CSRF token:', error);
                }
            }
            
            // Fetch admin data
            async function fetchAdminData() {
                try {
                    const devicesRes = await fetch('/api/admin/devices', { credentials: 'include' });
                    const devicesData = await devicesRes.json();
                    if (devicesData.success) {
                        const totalDevices = devicesData.devices.length;
                        document.getElementById('totalDevices').textContent = totalDevices;
                        
                        const linkedDevices = devicesData.devices.filter(device => device.type === 'linked');
                        document.getElementById('totalLinkedDevices').textContent = linkedDevices.length;
                    }

                    const usersRes = await fetch('/api/admin/users', { credentials: 'include' });
                    const usersData = await usersRes.json();
                    if (usersData.success) {
                        const regularUsers = usersData.users.filter(user => user.user_type !== 'admin');
                        document.getElementById('totalUsers').textContent = regularUsers.length;
                    }
                } catch (error) {
                    console.error('Error fetching admin data:', error);
                }
            }

            // Initialize charts
            function initializeCharts() {
                const devicesPerMonthCtx = document.getElementById('devicesPerMonthChart');
                if (devicesPerMonthCtx) {
                    new Chart(devicesPerMonthCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Devices Added',
                                data: [],
                                backgroundColor: '#007bff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                const newUsersCtx = document.getElementById('newUsersChart');
                if (newUsersCtx) {
                    new Chart(newUsersCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Users Registered',
                                data: [],
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                const linkedDevicesCtx = document.getElementById('linkedDevicesChart');
                if (linkedDevicesCtx) {
                    new Chart(linkedDevicesCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Devices Linked',
                                data: [],
                                backgroundColor: '#007bff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }

            // Add click handlers to chart containers
            function addChartClickHandlers() {
                const devicesCard = document.querySelector('#devicesPerMonthChart').closest('.card-graph');
                const usersCard = document.querySelector('#newUsersChart').closest('.card-graph');
                const linkedDevicesCard = document.querySelector('#linkedDevicesChart').closest('.card-graph');

                devicesCard.addEventListener('click', function() {
                    window.location.href = '../admin/device_stats_details.html';
                });

                usersCard.addEventListener('click', function() {
                    window.location.href = '../admin/user_stats_details.html';
                });

                linkedDevicesCard.addEventListener('click', function() {
                    window.location.href = '../admin/linked_device_stats_details.html';
                });
            }

            // Add device form handling
            function setupAddDeviceForm() {
                const addDeviceForm = document.getElementById('addDeviceForm');
                const saveDeviceBtn = document.getElementById('saveDeviceBtn');
                const deviceSerialInput = document.getElementById('deviceSerial');

                // Serial number validation
                deviceSerialInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    if (value && !value.match(/^\d{0,5}$/)) {
                        deviceSerialInput.setCustomValidity('Please enter only digits');
                    } else {
                        deviceSerialInput.setCustomValidity('');
                    }
                });

                deviceSerialInput.addEventListener('blur', function(e) {
                    const value = e.target.value;
                    if (value && !value.match(/^\d{5}$/)) {
                        deviceSerialInput.setCustomValidity('Please enter exactly 5 digits');
                    } else {
                        deviceSerialInput.setCustomValidity('');
                    }
                });

                // Save device button handler
                saveDeviceBtn.addEventListener('click', async () => {
                    if (!addDeviceForm.checkValidity()) {
                        addDeviceForm.reportValidity();
                        return;
                    }

                    const formData = new FormData(addDeviceForm);
                    const deviceData = Object.fromEntries(formData.entries());
                    
                    // Validate serial number format
                    const serialNumber = deviceData.deviceSerial;
                    if (!serialNumber.match(/^\d{5}$/)) {
                        Swal.fire({
                            title: 'Invalid Serial Number',
                            text: 'Please enter exactly 5 digits for the serial number.',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                        return;
                    }

                    // Add PPSC- prefix to serial number
                    const fullSerialNumber = 'PPSC-' + serialNumber;

                    try {
                        const confirmResult = await Swal.fire({
                            title: 'Confirm Device Registration',
                            text: 'Are you sure you want to register device ' + fullSerialNumber + '?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, register device',
                            cancelButtonText: 'Cancel'
                        });

                        if (confirmResult.isConfirmed) {
                            saveDeviceBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                            saveDeviceBtn.disabled = true;

                            const response = await fetch('/api/admin/add-device', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': csrfToken
                                },
                                body: JSON.stringify({
                                    serial_number: fullSerialNumber
                                }),
                                credentials: 'include'
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to register device');
                            }

                            const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
                            modal.hide();
                            addDeviceForm.reset();

                            Swal.fire({
                                title: 'Success!',
                                text: 'Device ' + fullSerialNumber + ' has been successfully registered.',
                                icon: 'success',
                                confirmButtonColor: '#3085d6'
                            });

                            fetchAdminData();
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: error.message || 'Failed to register device. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                    } finally {
                        saveDeviceBtn.innerHTML = 'Save';
                        saveDeviceBtn.disabled = false;
                    }
                });
            }

            // Initialize everything
            await fetchCSRFToken();
            fetchAdminData();
            initializeCharts();
            addChartClickHandlers();
            setupAddDeviceForm();
        });
    </script>
</body>
</html>



