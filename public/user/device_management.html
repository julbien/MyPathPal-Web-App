<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Device Management</title>
  <!-- links -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body>
  <!-- navbar -->
  <div id="navbar-container"></div>

  <!-- breadcrumb -->
  <nav aria-label="breadcrumb" class="mt-4 ms-4">
    <ol class="breadcrumb">
      <!-- dashboard link to redirect to dashboard page -->
      <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
      <!-- current page -->
      <li class="breadcrumb-item active" aria-current="page">Device Management</li>
    </ol>
  </nav>

  <!-- device management container -->
  <div class="device-management-container mt-4">
    <div class="header-row">
      <h4 class="mb-0">Device Management</h4>
      <!-- button to open the modal for adding a new device -->
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">Link Device</button>
    </div>

    <!-- table to display the devices linked to the user -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Serial Number</th>
            <th>Device Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- if no devices are found, display this message -->
          <tr>
            <td colspan="5" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-box-open mb-2 icon-2rem"></i>
                <p class="mb-0">No devices found</p>
                <small>Click "Link Device" to link a new device</small>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold" id="addDeviceModalLabel">Link Device</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addDeviceForm">
            <div class="mb-3">
              <label for="deviceName" class="form-label fw-semibold">Device Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="deviceName" name="deviceName" placeholder="Enter device name" required>
            </div>
            <div class="mb-3">
              <label for="deviceSerial" class="form-label fw-semibold">Serial Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="deviceSerial" name="deviceSerial" placeholder="Enter 5-digit number" maxlength="5" required>
              <div class="form-text">Enter 5-digit number (will be prefixed with PPSC-)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveDeviceBtn">Link Device</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="/js/navbar.js"></script>

  <!-- device management script -->
  <script>
    // Global CSRF token
    let csrfToken = null;

    // Global function to fetch CSRF token
    async function fetchCSRFToken() {
        try {
            const response = await fetch('/api/devices/csrf-token', { 
                method: 'GET',
                credentials: 'include' 
            });
            const data = await response.json();
            if (data.success) {
                csrfToken = data.token;
                console.log('CSRF Token fetched successfully:', csrfToken);
            } else {
                console.error('Failed to fetch CSRF token:', data.message);
            }
        } catch (error) {
            console.error('Error fetching CSRF token:', error);
        }
    }

    // Load navbar
    fetch('/components/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-container').innerHTML = html;
      })
      .catch(error => console.error('Error loading navbar:', error));

    // Device unlink with OTP verification (similar to registration)
        async function deleteDevice(deviceId) {
            const result = await Swal.fire({
                title: 'Unlink Device',
                text: 'Are you sure you want to unlink this device? A verification code will be sent to your email.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, send verification code',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal2-popup-small',
                    title: 'swal2-title-small',
                    content: 'swal2-content-small',
                    confirmButton: 'swal2-confirm-button-small',
                    cancelButton: 'swal2-cancel-button-small'
                }
            });

            if (result.isConfirmed) {
                try {
                    // Step 1: Request OTP (similar to registration)
                    const response = await fetch(`/api/devices/unlink-request/${deviceId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        credentials: 'include'
                    });

                    const data = await response.json();
                    console.log('OTP request response:', response.status, data); // Debug log

                    if (response.ok) {
                        // Step 2: Show OTP input dialog (similar to registration)
                        const { value: otp } = await Swal.fire({
                            title: 'Enter Verification Code',
                            text: `A 4-digit verification code has been sent to your email for device "${data.deviceName}".`,
                            input: 'text',
                            inputPlaceholder: 'Enter 4-digit code',
                            inputAttributes: {
                                maxlength: 4,
                                pattern: '[0-9]{4}',
                                inputmode: 'numeric'
                            },
                            showCancelButton: true,
                            confirmButtonText: 'Verify',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            customClass: {
                                popup: 'swal2-popup-small',
                                title: 'swal2-title-small',
                                content: 'swal2-content-small',
                                confirmButton: 'swal2-confirm-button-small',
                                cancelButton: 'swal2-cancel-button-small'
                            },
                            inputValidator: (value) => {
                                if (!value || !value.match(/^\d{4}$/)) {
                                    return 'Please enter a valid 4-digit code';
                                }
                            }
                        });

                        if (otp) {
                            // Allow up to 3 attempts for OTP verification
                            let attempts = 0;
                            const maxAttempts = 3;
                            let currentOtp = otp;
                            
                            while (attempts < maxAttempts) {
                                // Refresh CSRF token before verification
                                await fetchCSRFToken();
                                
                                // Step 3: Verify OTP and unlink
                                const verifyResponse = await fetch('/api/devices/unlink-verify', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRF-Token': csrfToken
                                    },
                                    credentials: 'include',
                                    body: JSON.stringify({ otp: currentOtp })
                                });

                                const verifyData = await verifyResponse.json();

                                if (verifyResponse.ok) {
                                    await Swal.fire({
                                        title: 'Device Unlinked!',
                                        text: verifyData.message,
                                        icon: 'success',
                                        confirmButtonColor: '#3085d6',
                                        customClass: {
                                            popup: 'swal2-popup-small',
                                            title: 'swal2-title-small',
                                            content: 'swal2-content-small',
                                            confirmButton: 'swal2-confirm-button-small'
                                        }
                                    });
                                    // Reload devices after unlink
                                    if (typeof loadDevices === 'function') loadDevices();
                                    break; // Success, exit the loop
                                } else {
                                    attempts++;
                                    const remainingAttempts = maxAttempts - attempts;
                                    
                                    if (attempts >= maxAttempts) {
                                        // Max attempts reached, show error and close
                                        await Swal.fire({
                                            title: 'Verification Failed',
                                            text: `Maximum attempts reached. ${verifyData.message || 'Please try again later.'}`,
                                            icon: 'error',
                                            confirmButtonColor: '#d33',
                                            customClass: {
                                                popup: 'swal2-popup-small',
                                                title: 'swal2-title-small',
                                                content: 'swal2-content-small',
                                                confirmButton: 'swal2-confirm-button-small'
                                            }
                                        });
                                        break;
                                    } else {
                                        // Show error and ask for new OTP
                                        const { value: newOtp } = await Swal.fire({
                                            title: 'Invalid Code',
                                            text: `${verifyData.message || 'Invalid verification code.'} You have ${remainingAttempts} attempt(s) remaining.`,
                                            input: 'text',
                                            inputPlaceholder: 'Enter 4-digit code',
                                            inputAttributes: {
                                                maxlength: 4,
                                                pattern: '[0-9]{4}',
                                                inputmode: 'numeric'
                                            },
                                            showCancelButton: true,
                                            confirmButtonText: 'Verify',
                                            cancelButtonText: 'Cancel',
                                            confirmButtonColor: '#d33',
                                            cancelButtonColor: '#3085d6',
                                            customClass: {
                                                popup: 'swal2-popup-small',
                                                title: 'swal2-title-small',
                                                content: 'swal2-content-small',
                                                confirmButton: 'swal2-confirm-button-small',
                                                cancelButton: 'swal2-cancel-button-small'
                                            },
                                            inputValidator: (value) => {
                                                if (!value || !value.match(/^\d{4}$/)) {
                                                    return 'Please enter a valid 4-digit code';
                                                }
                                            }
                                        });
                                        
                                        if (!newOtp) {
                                            // User cancelled, exit the loop
                                            break;
                                        }
                                        currentOtp = newOtp;
                                    }
                                }
                            }
                        }
                    } else {
                        throw new Error(data.message || 'Failed to send verification code');
                    }
                } catch (error) {
                    console.error('Error unlinking device:', error);
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'Failed to unlink device',
                        icon: 'error',
                        confirmButtonColor: '#3085d6',
                        customClass: {
                            popup: 'swal2-popup-small',
                            title: 'swal2-title-small',
                            content: 'swal2-content-small',
                            confirmButton: 'swal2-confirm-button-small'
                        }
                    });
                }
            }
        }

    document.addEventListener('DOMContentLoaded', async function () {
      // Fetch CSRF token first
      await fetchCSRFToken();
      
      // Add Device Form Handling
      const addDeviceForm = document.getElementById('addDeviceForm');
      const saveDeviceBtn = document.getElementById('saveDeviceBtn');

      saveDeviceBtn.addEventListener('click', async () => {
        if (!addDeviceForm.checkValidity()) {
          addDeviceForm.reportValidity();
          return;
        }

        const formData = new FormData(addDeviceForm);
        const deviceData = Object.fromEntries(formData.entries());
        
        // Validate serial number format
        const serialNumber = deviceData.deviceSerial;
        if (!serialNumber.match(/^\d{5}$/)) {
          Swal.fire({
            title: 'Invalid Serial Number',
            text: 'Please enter exactly 5 digits for the serial number.',
            icon: 'error',
            confirmButtonColor: '#3085d6'
          });
          return;
        }

        // add PPSC- prefix to serial number
        deviceData.deviceSerial = 'PPSC-' + deviceData.deviceSerial;

        try {
          // heck if device is already linked
          const checkResponse = await fetch(`/api/devices/check-link/${deviceData.deviceSerial}`, {
            method: 'GET',
            credentials: 'include'
          });

          if (!checkResponse.ok) {
            throw new Error('Failed to check device status');
          }

          const checkData = await checkResponse.json();
          console.log('Check device response:', checkData);
          
          if (!checkData.success) {
            Swal.fire({
              title: 'Cannot Link Device',
              text: checkData.message || 'This device cannot be linked.',
              icon: 'error',
              confirmButtonColor: '#3085d6'
            });
            return;
          }

          // Confirm device registration
          const confirmResult = await Swal.fire({
            title: 'Confirm Device Registration',
            text: 'Are you sure you want to link this device to your account?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, link device',
            cancelButtonText: 'Cancel'
          });

          if (confirmResult.isConfirmed) {
            saveDeviceBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            saveDeviceBtn.disabled = true;

            const response = await fetch('/api/devices', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
              },
              body: JSON.stringify(deviceData),
              credentials: 'include'
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Failed to link device');
            }

            const data = await response.json();

            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
            modal.hide();
            addDeviceForm.reset();

            Swal.fire({
              title: 'Success!',
              text: 'Device has been successfully linked to your account.',
              icon: 'success',
              confirmButtonColor: '#3085d6'
            });

            // Refresh the devices table
            loadDevices();
          }
        } catch (error) {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error!',
            text: error.message || 'Failed to link device. Please try again.',
            icon: 'error',
            confirmButtonColor: '#3085d6'
          });
        } finally {
          saveDeviceBtn.innerHTML = 'Link Device';
          saveDeviceBtn.disabled = false;
        }
      });

      // Function to load devices
      async function loadDevices() {
        try {
          const response = await fetch('/api/devices', {
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            const tbody = document.querySelector('table tbody');
            
            if (data.devices && data.devices.length > 0) {
              tbody.innerHTML = data.devices.map(device => `
                <tr>
                  <td>${device.device_id}</td>
                  <td>${device.serial_number}</td>
                  <td>${device.device_name || 'Unnamed Device'}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" title="Unlink Device" onclick="deleteDevice(${device.device_id})">
                      <i class="fas fa-unlink"></i> Unlink
                    </button>
                  </td>
                </tr>
              `).join('');
            } else {
              tbody.innerHTML = `
                <tr>
                  <td colspan="5" class="text-center py-4">
                    <div class="text-muted">
                      <i class="fas fa-box-open mb-2 table-empty-icon"></i>
                      <p class="mb-0">No devices found</p>
                      <small>Click "Link Device" to register a new device</small>
                    </div>
                  </td>
                </tr>
              `;
            }
          }
        } catch (error) {
          console.error('Error loading devices:', error);
        }
      }

      // Load devices when page loads
      loadDevices();

      // Serial Number Format Validation
      const deviceSerial = document.getElementById('deviceSerial');
      deviceSerial.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value && !value.match(/^\d{5}$/)) {
          deviceSerial.setCustomValidity('Please enter exactly 5 digits');
        } else {
          deviceSerial.setCustomValidity('');
        }
      });
    });
  </script>
</body>
</html>
